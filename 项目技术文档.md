# 2FA Authenticator 项目技术文档

## 1. 项目概述

### 1.1 项目定位

2FA Authenticator 是一个基于 Cloudflare Worker 的 TOTP（基于时间的一次性密码）验证码生成和管理工具。它解决了团队内部共享 2FA 账号的痛点，同时也支持个人使用场景。

### 1.2 核心价值

| 场景 | 传统方案的问题 | 本项目的解决方案 |
|------|---------------|-----------------|
| 团队共享服务器账号 | 需要传递手机、截图验证码 | 网页直接查看，实时刷新 |
| 运维人员离职交接 | 2FA 密钥难以迁移 | 集中存储，批量导出 |
| 多设备同步 | 各 App 数据不互通 | 网页访问，跨设备同步 |
| 个人备份 | 手机丢失导致 2FA 丢失 | 云端备份，随时恢复 |

### 1.3 部署架构

```
┌─────────────────────────────────────────────────────────────┐
│                    Cloudflare Edge Network                   │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌──────────────────┐         ┌──────────────────┐          │
│  │  2fa-worker-v2   │         │   2fa-personal   │          │
│  │   (团队版)        │         │    (个人版)       │          │
│  └────────┬─────────┘         └────────┬─────────┘          │
│           │                            │                     │
│           ▼                            ▼                     │
│  ┌──────────────────┐         ┌──────────────────┐          │
│  │   KV Namespace   │         │   KV Namespace   │          │
│  │   (团队数据)      │         │   (个人数据)      │          │
│  └──────────────────┘         └──────────────────┘          │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

## 2. 技术架构

### 2.1 技术栈

| 层级 | 技术选型 | 说明 |
|------|---------|------|
| **运行时** | Cloudflare Worker | 边缘计算，全球低延迟 |
| **后端框架** | Hono | 轻量级 Web 框架，专为 Edge 优化 |
| **数据存储** | Cloudflare KV | 键值存储，最终一致性 |
| **前端框架** | Vue 3 + Composition API | 响应式 UI |
| **构建工具** | Vite | 快速构建，HMR 支持 |
| **样式** | Tailwind CSS | 原子化 CSS |
| **认证** | JWT | 无状态认证 |
| **二维码** | html5-qrcode | 摄像头扫码 |
| **TOTP** | 自研实现 | 基于 RFC 6238 |

### 2.2 目录结构

```
2fa-authenticator/
├── src/                           # Worker 后端源码
│   ├── index.ts                   # 入口，路由注册，SPA fallback
│   ├── types.ts                   # TypeScript 类型定义（含 ASSETS）
│   ├── routes/
│   │   ├── accounts.ts            # GET /api/accounts - 获取账号列表
│   │   └── admin.ts               # /api/admin/* - 管理接口
│   └── utils/
│       ├── totp.ts                # TOTP 算法实现（与前端同步）
│       ├── auth.ts                # JWT 签发与验证
│       ├── kv.ts                  # KV 存储操作封装
│       └── validation.ts          # 输入验证工具
│
├── web/                           # Vue 3 前端
│   ├── src/
│   │   ├── App.vue                # 根组件
│   │   ├── main.ts                # 入口，路由配置
│   │   ├── views/
│   │   │   ├── Home.vue           # 首页 - 验证码展示
│   │   │   └── Admin.vue          # 管理后台（响应式设计、下拉菜单）
│   │   ├── components/
│   │   │   └── AccountCard.vue    # 账号卡片组件
│   │   └── utils/
│   │       ├── api.ts             # API 请求封装，类型定义
│   │       └── totp.ts            # 前端 TOTP（与后端同步）
│   ├── index.html
│   ├── vite.config.ts
│   └── tailwind.config.js         # 含自定义断点 xs:480px
│
├── wrangler.toml                  # Worker 配置（含多环境、ASSETS binding）
├── dev-server.mjs                 # 本地开发模拟 API
├── package.json
└── README.md
```

**代码同步说明：**
- `src/utils/totp.ts` 与 `web/src/utils/totp.ts` 实现相同，修改时需同步
- `src/types.ts` 中的 `Account` 类型与 `web/src/utils/api.ts` 中的定义需保持一致

### 2.3 数据模型

```typescript
// 账号数据结构
interface Account {
  id: string;        // UUID
  name: string;      // 账号名称（如 user@gmail.com）
  issuer: string;    // 发行方（如 Google、GitHub）
  secret: string;    // Base32 编码的密钥
  digits: number;    // 验证码位数（默认 6）
  period: number;    // 刷新周期（默认 30 秒）
  order: number;     // 排序权重
  isPublic: boolean; // 是否公开（团队模式下生效）
}

// KV 存储结构
// Key: "accounts"
// Value: { accounts: Account[] }
```

### 2.4 API 设计

| 端点 | 方法 | 认证 | 说明 |
|------|------|------|------|
| `/api/accounts` | GET | 可选 | 获取账号列表（未登录只返回公开账号） |
| `/api/admin/login` | POST | 否 | 管理员登录，返回 JWT |
| `/api/admin/accounts` | GET | 是 | 获取所有账号（含隐私） |
| `/api/admin/accounts` | POST | 是 | 创建账号 |
| `/api/admin/accounts/:id` | PUT | 是 | 更新账号 |
| `/api/admin/accounts/:id` | DELETE | 是 | 删除账号 |
| `/api/admin/accounts/batch-delete` | POST | 是 | 批量删除 |
| `/api/admin/accounts/batch-visibility` | POST | 是 | 批量设置可见性 |
| `/api/admin/accounts/import` | POST | 是 | 批量导入 |
| `/api/admin/accounts/reorder` | POST | 是 | 调整排序 |

### 2.5 SPA Fallback 实现

由于使用 Vue Router 的 History 模式，直接访问 `/admin` 等路由会返回 404。通过 Worker 代码实现 SPA fallback：

```typescript
// src/index.ts
app.get('*', async (c) => {
  const url = new URL(c.req.url);

  // 尝试获取静态资源
  let response = await c.env.ASSETS.fetch(c.req.raw);

  // 如果是 404 且不是 API 请求，返回 index.html
  if (response.status === 404 && !url.pathname.startsWith('/api/')) {
    const indexUrl = new URL('/', c.req.url);
    response = await c.env.ASSETS.fetch(new Request(indexUrl.toString()));
  }

  return response;
});
```

配置要点（wrangler.toml）：
```toml
[assets]
directory = "./web/dist"
binding = "ASSETS"  # 必须设置 binding 才能在代码中访问
```

## 3. 核心功能实现

### 3.1 TOTP 算法

基于 RFC 6238 实现，核心流程：

```
1. 计算时间步长: T = floor(当前时间戳 / 30)
2. 将 T 转换为 8 字节大端序
3. 使用 HMAC-SHA1(secret, T) 生成哈希
4. 动态截断：取哈希最后 4 位作为偏移量，提取 4 字节
5. 取模得到 6 位数字验证码
```

### 3.2 团队模式权限控制

```typescript
// src/routes/accounts.ts
accounts.get('/', async (c) => {
  let accountList = await getAccounts();

  // PUBLIC_MODE=true 时跳过权限检查（个人模式）
  if (c.env.PUBLIC_MODE === 'true') {
    return c.json({ accounts: accountList });
  }

  // 团队模式：检查登录状态
  const token = c.req.header('Authorization')?.replace('Bearer ', '');
  const isLoggedIn = token ? await verifyToken(token, c.env) : false;

  // 未登录只返回公开账号
  if (!isLoggedIn) {
    accountList = accountList.filter(acc => acc.isPublic === true);
  }

  return c.json({ accounts: accountList });
});
```

### 3.3 多格式导入导出

支持的格式：

| 格式 | 导入 | 导出 | 兼容应用 |
|------|------|------|---------|
| Aegis JSON | ✅ | ✅ | Aegis Authenticator |
| 简单 JSON | ✅ | ✅ | 自定义格式 |
| TSV | ✅ | ✅ | Excel、Google Sheets |
| CSV | ✅ | ✅ | 通用表格软件 |

导入时自动检测格式：
1. 尝试 JSON 解析 → 检查是否有 `db.entries`（Aegis）或 `keys`（简单 JSON）
2. 解析失败 → 按 TSV/CSV 解析（自动检测分隔符）

### 3.4 二维码扫描

使用 html5-qrcode 库实现摄像头扫码，解析 otpauth:// URI：

```
otpauth://totp/Google:user@gmail.com?secret=JBSWY3DPEHPK3PXP&issuer=Google&digits=6&period=30
         ^^^^  ^^^^^^ ^^^^^^^^^^^^^       ^^^^^^^^^^^^^^^^        ^^^^^^        ^^^^^^
         类型  issuer     name                  密钥               位数         周期
```

**扫码方式**：

| 方式 | 说明 |
|------|------|
| 摄像头扫码 | 实时摄像头扫描，支持前后摄像头切换 |
| 图片上传 | 选择本地图片识别二维码 |
| 粘贴截图 | Ctrl+V 粘贴剪贴板图片，自动识别 |

**图片预处理**：
- 支持多轮尝试：原图 → 灰度增强对比度 → 二值化
- 自适应阈值计算，提高识别成功率

**摄像头权限处理**：

移动端扫码需要摄像头权限，系统会智能处理各种情况：

| 情况 | 处理方式 |
|------|---------|
| 权限被拒绝 | 显示友好提示，引导用户在浏览器设置中开启权限 |
| 无摄像头设备 | 提示"未检测到摄像头设备" |
| 其他错误 | 显示具体错误信息 |

权限引导包含各平台的开启步骤：
- iOS Safari: 设置 > Safari > 摄像头 > 允许
- Android Chrome: 点击地址栏锁图标 > 网站设置 > 摄像头
- 桌面浏览器: 点击地址栏左侧图标 > 允许摄像头

### 3.5 移动端响应式设计

管理后台针对移动端进行了专门优化：

| 特性 | 实现方式 |
|------|---------|
| 工具栏 | 图标按钮，标题与操作在同一行 |
| 批量操作 | 下拉菜单形式，避免按钮挤压 |
| 账号列表 | 2 列网格布局（sm 断点以上） |
| 账号卡片 | 颜色区分公开/隐私状态 |
| 自定义断点 | xs:480px 适配超小屏幕 |

**批量操作下拉菜单**：

选中账号后，顶部工具栏显示"已选 N"按钮，点击展开下拉菜单：
- 设为公开
- 设为隐私
- 删除
- 取消选择

## 4. 团队协作功能

### 4.1 公开/隐私分组

**设计理念**：团队中不同成员需要访问不同的账号

| 账号类型 | 未登录可见 | 登录后可见 | 适用场景 |
|---------|-----------|-----------|---------|
| 公开账号 | ✅ | ✅ | 测试环境、共享服务 |
| 隐私账号 | ❌ | ✅ | 生产环境、敏感服务 |

**使用流程**：
1. 管理员登录后添加账号
2. 根据敏感程度设置公开/隐私
3. 团队成员无需登录即可查看公开账号
4. 需要查看隐私账号时，输入管理员密码登录

### 4.2 批量操作

| 操作 | 说明 | 适用场景 |
|------|------|---------|
| 批量导入 | 从其他 2FA 应用迁移 | 团队 2FA 集中化 |
| 批量导出 | 备份或迁移到其他系统 | 数据备份、离职交接 |
| 批量删除 | 清理过期账号 | 项目下线 |
| 批量设置可见性 | 一键公开/隐私 | 权限调整 |

### 4.3 分组显示

按 Issuer 自动分组，便于快速定位：

```
▼ AWS (3)
  ├── prod-admin      ******
  ├── staging-admin   ******
  └── dev-admin       ******

▼ GitHub (2)
  ├── org-bot         ******
  └── deploy-key      ******

▼ Google (1)
  └── workspace-admin ******
```

## 5. 安全设计

### 5.1 密钥管理

| 密钥 | 存储位置 | 说明 |
|------|---------|------|
| ADMIN_PASSWORD | Cloudflare Secrets | 管理员密码，不在代码中 |
| JWT_SECRET | Cloudflare Secrets（可选） | 不设置时基于密码自动生成 |
| TOTP Secrets | Cloudflare KV | 加密存储在边缘节点 |

### 5.2 认证机制

```
1. 用户输入密码
2. 后端验证密码，签发 JWT（有效期 24 小时）
3. 前端存储 JWT 到 localStorage
4. 后续请求携带 Authorization: Bearer <token>
5. 后端验证 JWT 签名和有效期
```

### 5.3 安全建议

- **生产环境**：配合 Cloudflare Access 限制访问来源
- **敏感账号**：设置为隐私，仅管理员可见
- **定期轮换**：定期更换 ADMIN_PASSWORD
- **监控审计**：开启 Cloudflare Worker 日志

## 6. 部署运维

### 6.1 环境变量

| 变量 | 必需 | 默认值 | 说明 |
|------|------|--------|------|
| ADMIN_PASSWORD | 是 | - | 管理员密码 |
| JWT_SECRET | 否 | 基于密码生成 | JWT 签名密钥 |
| PUBLIC_MODE | 否 | false | 设为 true 启用个人模式 |

### 6.2 多环境部署

```bash
# 团队版
npx wrangler deploy

# 个人版
npx wrangler deploy --env personal

# 设置个人版 secrets
npx wrangler secret put ADMIN_PASSWORD --env personal
npx wrangler secret put PUBLIC_MODE --env personal  # 输入 true
```

### 6.3 数据备份

```bash
# 导出 KV 数据
npx wrangler kv:key get --binding=KV "accounts" > backup.json

# 恢复 KV 数据
npx wrangler kv:key put --binding=KV "accounts" --path=backup.json
```

## 7. 适用场景总结

| 场景 | 推荐模式 | 配置要点 |
|------|---------|---------|
| 运维团队共享服务器 2FA | 团队模式 | 生产环境设为隐私，测试环境设为公开 |
| 开发团队共享测试账号 | 团队模式 | 全部设为公开，方便快速访问 |
| 个人 2FA 云备份 | 个人模式 | PUBLIC_MODE=true，配合 Cloudflare Access |
| 小团队快速共享 | 团队模式 | 简单密码，全部公开 |
| 企业安全合规 | 团队模式 | 复杂密码 + Cloudflare Access + 审计日志 |

## 8. 使用模式对比

### 8.1 团队模式（默认）

适合团队共享 2FA 账号的场景：

- 未登录用户只能看到**公开账号**的验证码
- 管理员登录后可看到所有账号（包括隐私账号）
- 支持将账号设置为公开或隐私
- 适合：运维团队共享服务器账号、开发团队共享测试账号等

### 8.2 个人模式

适合个人使用的场景：

- 所有账号直接显示，无需区分公开/隐私
- 仍需管理员密码才能进入后台管理
- 设置 `PUBLIC_MODE=true` 启用
- 适合：个人 2FA 备份、快速查看验证码
